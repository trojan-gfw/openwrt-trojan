#
# Copyright (C) 2018-2019 wongsyrone
#
# This is free software, licensed under the GNU General Public License v3.
# See /LICENSE for more information.
#

include $(TOPDIR)/rules.mk

PKG_NAME:=trojan
PKG_VERSION:=1.13.0
PKG_RELEASE:=1

PKG_SOURCE_PROTO:=git
PKG_SOURCE_URL:=https://github.com/trojan-gfw/trojan.git
PKG_SOURCE_SUBDIR:=$(PKG_NAME)-$(PKG_VERSION)
PKG_SOURCE_VERSION:=842ad5bb07eb8bce035fb274571e586629a97c99
PKG_SOURCE:=$(PKG_NAME)-$(PKG_VERSION)-$(PKG_SOURCE_VERSION).tar.gz
CMAKE_INSTALL:=1
PKG_BUILD_PARALLEL:=0

PKG_BUILD_DEPENDS:=openssl1.1

PKG_LICENSE:=GPL-3.0

PKG_MAINTAINER:=GreaterFire

include $(INCLUDE_DIR)/package.mk
include $(INCLUDE_DIR)/cmake.mk

TARGET_CXXFLAGS += -Wall -Wextra
TARGET_CXXFLAGS += $(FPIC)

# LTO
TARGET_CXXFLAGS += -flto
TARGET_LDFLAGS += -flto

# CXX standard
TARGET_CXXFLAGS += -std=c++11

TARGET_CXXFLAGS := $(filter-out -O%,$(TARGET_CXXFLAGS)) -O3
MY_OPENSSL_DIR:=$(BUILD_DIR)/openssl1.1_staging_dir/usr

TARGET_CXXFLAGS += -ffunction-sections -fdata-sections
TARGET_LDFLAGS += -Wl,--gc-sections

CMAKE_FIND_ROOT_PATH := $(MY_OPENSSL_DIR);$(CMAKE_FIND_ROOT_PATH)
TARGET_CXXFLAGS := -I$(MY_OPENSSL_DIR)/include $(TARGET_CXXFLAGS)
TARGET_LDFLAGS := -L$(MY_OPENSSL_DIR)/lib $(TARGET_LDFLAGS)



CMAKE_OPTIONS += \
	-DENABLE_MYSQL=OFF \
	-DENABLE_SSL_KEYLOG=ON \
	-DENABLE_NAT=ON \
	-DFORCE_TCP_FASTOPEN=OFF \
	-DSYSTEMD_SERVICE=OFF \
	-DOPENSSL_USE_STATIC_LIBS=TRUE \
	-DBoost_DEBUG=ON \
	-DBoost_NO_BOOST_CMAKE=ON



define Package/trojan
	SECTION:=net
	CATEGORY:=Network
	TITLE:=An unidentifiable mechanism that helps you bypass GFW
	URL:=https://github.com/trojan-gfw/trojan
	DEPENDS:=+libpthread +libstdcpp \
		+boost +boost-system +boost-program_options +boost-date_time
endef



define Package/trojan/install
	$(INSTALL_DIR) $(1)/usr/bin
	$(INSTALL_BIN) $(PKG_INSTALL_DIR)/usr/bin/trojan $(1)/usr/bin
	$(INSTALL_DIR) $(1)/etc/init.d
	$(INSTALL_BIN) files/trojan.init $(1)/etc/init.d/trojan
	$(INSTALL_DIR) $(1)/etc/config
	$(INSTALL_DATA) files/trojan.config $(1)/etc/config/trojan
	$(INSTALL_DIR) $(1)/etc/trojan
	$(INSTALL_CONF) $(PKG_BUILD_DIR)/examples/client.json-example $(1)/etc/trojan/client.json
	$(INSTALL_CONF) $(PKG_BUILD_DIR)/examples/forward.json-example $(1)/etc/trojan/forward.json
	$(INSTALL_CONF) $(PKG_BUILD_DIR)/examples/nat.json-example $(1)/etc/trojan/nat.json
	$(INSTALL_CONF) $(PKG_BUILD_DIR)/examples/server.json-example $(1)/etc/trojan/server.json
endef

define Package/trojan/postrm
#!/bin/sh
rmdir --ignore-fail-on-non-empty /etc/trojan
exit 0
endef


$(eval $(call BuildPackage,trojan))
